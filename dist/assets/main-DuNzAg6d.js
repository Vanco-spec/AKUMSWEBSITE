import{initializeApp as F}from"https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";import{getAuth as P,onAuthStateChanged as k,createUserWithEmailAndPassword as A,signInWithEmailAndPassword as x,signOut as C,sendPasswordResetEmail as U}from"https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";import{getFirestore as T,setDoc as R,doc as y,serverTimestamp as M,getDoc as N,collection as v,addDoc as S,getDocs as $,updateDoc as q,arrayUnion as O}from"https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";import{getStorage as H,ref as z,uploadBytes as G,getDownloadURL as W}from"https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function s(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(o){if(o.ep)return;o.ep=!0;const n=s(o);fetch(o.href,n)}})();const Y={apiKey:"AIzaSyDi-PnbqxyJnH6l8ePZeLCFt0wpfseq3ow",authDomain:"akums-website.firebaseapp.com",projectId:"akums-website",storageBucket:"akums-website.firebasestorage.app",messagingSenderId:"786101532621",appId:"1:786101532621:web:cc93facfad185a93a1b684",measurementId:"G-N10F537FMY"},b=F(Y),m=P(b),u=T(b),_=H(b);k(m,e=>{e?(console.log("User signed in:",e.email),B(!0,e)):(console.log("No user signed in"),B(!1))});function B(e,t=null){document.getElementById("loginBtn").style.display=e?"none":"block",document.getElementById("signupBtn").style.display=e?"none":"block",document.getElementById("logoutBtn").style.display=e?"block":"none",document.getElementById("profileBtn").style.display=e?"block":"none"}document.getElementById("signupForm").addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("signupEmail").value,s=document.getElementById("signupPassword").value,r=document.getElementById("confirmPassword").value,o=document.getElementById("phoneNumber").value,n=document.getElementById("countryCode").value,a="guest";if(t===""){alert("Please enter your email.");return}if(s!==r){alert("Passwords do not match.");return}if(o===""){alert("Please enter your phone number.");return}A(m,t,s).then(l=>{const c=l.user;console.log("User UID: ",c.uid),R(y(u,"users",c.uid),{email:c.email,timestamp:M(),userId:c.uid,password:s,phoneNumber:n+o,group:a}).then(()=>{console.log("User data stored in Firestore!"),alert("Sign-up successful! Welcome to the platform."),p(c);const i=document.getElementById("authModal");bootstrap.Modal.getInstance(i).hide(),window.location.href="/index.html"}).catch(i=>{console.error("Error storing user data:",i),alert("Sign-up successful, but we encountered an issue storing your information. Please try again.")})}).catch(l=>{console.error("Sign-up error:",l.message),alert("Sign-up unsuccessful: "+l.message)})});document.getElementById("loginForm").addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("loginEmail").value,s=document.getElementById("loginPassword").value;x(m,t,s).then(r=>{const o=r.user,n=y(u,"users",o.uid);N(n).then(a=>{if(a.exists()){const l=a.data();console.log("User data fetched from Firestore:",l),p(o),alert("Login successful");const c=document.getElementById("authModal");bootstrap.Modal.getInstance(c).hide(),window.location.href="/index.html"}else console.error("No document found for the user in Firestore."),alert("Login successful, but user details could not be retrieved.")}).catch(a=>{console.error("Error fetching user data:",a),alert("Login successful, but there was an error fetching your details.")})}).catch(r=>{console.error("Login error:",r.message),alert("Login failed. Please check your email and password.")})});function p(e){const t=document.getElementById("profileEmail"),s=document.getElementById("admissionNumber");e?(document.getElementById("loginBtn").style.display="none",document.getElementById("signupBtn").style.display="none",document.getElementById("logoutBtn").style.display="block",document.getElementById("profileBtn").style.display="block"):(document.getElementById("loginBtn").style.display="block",document.getElementById("signupBtn").style.display="block",document.getElementById("logoutBtn").style.display="none",document.getElementById("profileBtn").style.display="none",t&&(t.textContent="Email: N/A"),s&&(s.textContent="Admission Number: N/A"))}document.getElementById("logoutBtn").addEventListener("click",()=>{C(m).then(()=>{console.log("User signed out successfully."),p(null),window.location.href="/index.html"}).catch(e=>{console.error("Log out error:",e),alert("An error occurred while logging out.")})});let E=document.querySelector(".nav-link.active");document.querySelectorAll(".nav-link[data-target]").forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();const s=this.getAttribute("data-target");if(!s){console.error("data-target attribute not found on the clicked link.");return}document.querySelectorAll(".tab-content").forEach(o=>{o.classList.remove("active")});const r=document.getElementById(s);if(!r){console.error("Element with ID '"+s+"' not found.");return}r.classList.add("active"),E&&E.classList.remove("active"),this.classList.add("active"),E=this})});document.getElementById("loginBtn").addEventListener("click",()=>{new bootstrap.Modal(document.getElementById("authModal")).show(),document.getElementById("authModalLabel").textContent="AUTHENTICATION",I()});document.getElementById("signupBtn").addEventListener("click",()=>{new bootstrap.Modal(document.getElementById("authModal")).show(),document.getElementById("authModalLabel").textContent="AUTHENTICATION",D()});function I(){document.getElementById("loginFormSection").style.display="block",document.getElementById("signupFormSection").style.display="none",document.getElementById("forgotPasswordSection").style.display="none"}function D(){document.getElementById("loginFormSection").style.display="none",document.getElementById("signupFormSection").style.display="block",document.getElementById("forgotPasswordSection").style.display="none"}function j(){document.getElementById("loginFormSection").style.display="none",document.getElementById("signupFormSection").style.display="none",document.getElementById("forgotPasswordSection").style.display="block"}document.getElementById("showSignUp").addEventListener("click",e=>{e.preventDefault(),D()});document.getElementById("showLogin").addEventListener("click",e=>{e.preventDefault(),I()});document.getElementById("showForgotPassword").addEventListener("click",e=>{e.preventDefault(),j()});document.getElementById("showLoginFromForgot").addEventListener("click",e=>{e.preventDefault(),I()});document.getElementById("forgotPasswordForm").addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("forgotPasswordEmail").value;if(!t){alert("Please enter your email address.");return}U(m,t).then(()=>{alert("Password reset email sent! Please check your inbox.");const s=document.getElementById("authModal");bootstrap.Modal.getInstance(s).hide()}).catch(s=>{alert("Error sending reset email: "+s.message)})});document.getElementById("messageForm").addEventListener("submit",function(e){e.preventDefault();const t=document.getElementById("name").value,s=document.getElementById("email").value,r=document.getElementById("message").value,o="unread";if(t===""){alert("Please enter your name.");return}const n=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!s.match(n)){alert("Please enter a valid email address.");return}if(r===""){alert("Please enter your message.");return}if(console.log(eventImage),!eventImage){alert("No image selected");return}alert("Form successfully submitted!");const a=v(u,"contactMessages");S(a,{name:t,email:s,message:r,status:o,timestamp:M()}).then(()=>{alert("Message sent successfully!"),console.log(`Uploading to: events/${eventImage.name}`)}).catch(l=>{alert("Error sending message: "+l.message)})});fetch("templates/home.html").then(e=>e.text()).then(e=>{document.getElementById("#home").innerHTML=e}).catch(e=>console.error("Error loading content:",e));fetch("templates/events.html").then(e=>e.text()).then(e=>{document.getElementById("#events").innerHTML=e;const t=document.getElementById("eventList");if(!t){console.error("Event list container not found.");return}console.log("Event list container found."),t.innerHTML="",K(t)}).catch(e=>console.error("Error loading content:",e));fetch("templates/about_us.html").then(e=>e.text()).then(e=>{document.getElementById("#about").innerHTML=e}).catch(e=>console.error("Error loading content:",e));fetch("templates/resources.html").then(e=>e.text()).then(e=>{document.getElementById("#resources").innerHTML=e}).catch(e=>console.error("Error loading content:",e));fetch("templates/account.html").then(e=>e.text()).then(e=>{document.getElementById("#account").innerHTML=e}).catch(e=>console.error("Error loading content:",e));document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector("#navbarNav"),t=document.querySelector(".navbar-toggler"),s=document.querySelectorAll(".nav-link"),r=document.querySelector("#profileDropdown");s.forEach(n=>{n.addEventListener("click",()=>{n!==r&&window.getComputedStyle(t).display!=="none"&&new bootstrap.Collapse(e,{toggle:!0}).hide()})}),document.querySelector(".dropdown-menu").addEventListener("click",n=>{n.stopPropagation()})});let w=0;const L=document.querySelector(".navbar");window.addEventListener("scroll",function(){let e=window.pageYOffset||document.documentElement.scrollTop;e>w?L.classList.add("hidden"):L.classList.remove("hidden"),w=e<=0?0:e});m.onAuthStateChanged(async e=>{if(e){const t=e.email,s=e.uid,r=document.getElementById("profileEmail");r&&(r.textContent=`Email: ${t}`);try{const o=y(u,"users",s),n=await N(o);if(n.exists()){const a=n.data(),l=a.admissionNumber||"N/A",c=a.group||"N/A",i=a.firstName||"N/A",d=a.secondName||"N/A",g=`${i} ${d}`,f=document.getElementById("username");f&&(f.textContent=`Name: ${g}`);const h=document.getElementById("admissionNumber");h&&(h.textContent=`Admission Number: ${l}`),localStorage.setItem("userGroup",c),console.log(`User Group: ${c}`)}else console.warn("User document does not exist in Firestore.")}catch(o){console.error("Error fetching admission number:",o.message)}}else console.log("Not logged in"),p(null),localStorage.removeItem("userGroup")});document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector('.btn-item[data-target="update_profile.html"]');e&&e.addEventListener("click",function(r){r.preventDefault(),console.log("Navigating to Update Profile page..."),window.location.href="update_profile.html"});const t=document.getElementById("#event");t&&t.addEventListener("click",function(r){if(r.target&&r.target.matches(".btn-item")){const o=r.target.getAttribute("data-target");r.preventDefault(),console.log("Target clicked:",o),new bootstrap.Modal(document.getElementById("eventFormModal")).show(),console.log("Initializing Event Form..."),s()}});function s(){const r=document.getElementById("eventForm");r?r.addEventListener("submit",async function(o){o.preventDefault();const n=document.getElementById("eventName").value,a=document.getElementById("eventImage").files[0],l=document.getElementById("eventLocation").value,c=document.getElementById("eventTime").value,i=document.getElementById("eventDescription").value;if(!n||!a||!l||!c||!i){alert("Please fill out all fields.");return}console.log("Event Name:",n),console.log("Event Image:",a),console.log("Event Location:",l),console.log("Event Time:",c),console.log("Event Description:",i);try{console.log("Starting Firebase operations...");const d=z(_,`events/${a.name}`);console.log("Uploading to Firebase Storage..."),await G(d,a),console.log("Image uploaded successfully!");const g=await W(d);console.log("Download URL:",g);const f=await S(v(u,"events"),{name:n,location:l,time:c,description:i,imageURL:g,timestamp:new Date});console.log("Event logged successfully with ID:",f.id),alert("Event logged successfully!"),r.reset(),bootstrap.Modal.getInstance(document.getElementById("eventFormModal")).hide(),setTimeout(()=>{window.location.href="index.html#account"},500)}catch(d){console.error("Error logging event:",d),alert("An error occurred while logging the event: "+d.message)}}):console.error('Form with ID "eventForm" not found.')}});async function K(e){try{console.log("Fetching events from Firestore...");const t=await $(v(u,"events"));console.log("Events fetched:",t.size);const s=m.currentUser,r=s?s.uid:null;t.empty?console.log("No events found."):t.forEach(o=>{const n=o.data(),a=o.id;console.log("Event data:",n);const l=document.createElement("div");l.classList.add("col-12","mb-3"),l.innerHTML=`
          <div class="card h-100 card-custom-shadow card-animated">
              <img src="${n.imageURL}" class="card-img-top" alt="Event Image" style="width: 100%; height: 200px; object-fit: cover;">
              <div class="card-body">
                  <h5 class="card-title">${n.name}</h5>
                  <p class="card-text"><strong>Date:</strong> ${n.time}</p>
                  <p class="card-text"><strong>Location:</strong> ${n.location}</p>
                  <p class="card-text">${n.description}</p>
                  <button class="btn btn-primary w-100 register-btn" data-event-id="${o.id||"missing-id"}">Register Now</button>
              </div>
          </div>
      `,e.appendChild(l),console.log("Event card added to the list.");const i=(n.members||[]).some(g=>g.uid===r),d=l.querySelector(".register-btn");i&&(d.textContent="Registered",d.classList.remove("btn-primary"),d.classList.add("btn-secondary"),d.disabled=!0)})}catch(t){console.error("Error fetching events or checking registration status:",t)}}document.addEventListener("click",async e=>{if(e.target.classList.contains("register-btn")){const t=e.target.getAttribute("data-event-id");console.log(`Registering for event: ${t}`);try{const s=m.currentUser;if(s){const{uid:r,email:o}=s,n=y(u,"events",t);await q(n,{members:O({uid:r,email:o})}),e.target.textContent="Registered",e.target.classList.remove("btn-primary"),e.target.classList.add("btn-secondary"),e.target.disabled=!0,alert("You have successfully registered for the event!")}else alert("Please log in to register for events.")}catch(s){console.error("Error registering for event:",s),alert("An error occurred while registering. Please try again.")}}});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("authModal"),t=document.getElementById("blur-background");e&&t?(e.addEventListener("show.bs.modal",()=>{t.classList.add("show")}),e.addEventListener("hidden.bs.modal",()=>{t.classList.remove("show")})):console.error("Modal or Blur Background element not found!")});
